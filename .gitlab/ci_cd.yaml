
stages:
  - ci
  - cd
  - cleanup
  - release

variables:
  PYTHON_VERSION: "3.11"
  IMAGE_BASE: python:${PYTHON_VERSION}-slim-bullseye
  GIT_DEPTH: "300"


.validate_input: &validate_input
  - |
    if [[ $TB_ADMIN_TOKEN =~ .*TB_ADMIN_TOKEN ]]; then
      echo "Go to the tokens section in your Workspace, copy the 'admin token' and set TB_ADMIN_TOKEN as a Secret in your Git repository"; exit 1;
    fi

.tb_deploy_ci:
  stage: ci
  image: ${IMAGE_BASE}
  interruptible: true
  before_script:
    - apt-get update && apt-get install -y --no-install-recommends git
  script:
    - *validate_input
    - _ENV_FLAGS="${ENV_FLAGS:=--last-partition --wait}"
    - cd $CI_PROJECT_DIR/$DATA_PROJECT_DIR
    - _NORMALIZED_ENV_NAME=$(echo $DATA_PROJECT_DIR | rev | cut -d "/" -f 1 | rev | tr '.-' '_')
    - source .tinyenv

    # Create Python Virtual Environment
    - python -m venv .venv
    - source .venv/bin/activate

    # Install Tinybird CLI
    - |
      if [ -f "requirements.txt" ]; then
        pip install -r requirements.txt
      else
        pip install tinybird-cli
      fi

    # Tinybird version
    - tb --version

    # Check all the data files syntax
    - tb check

    # Check auth
    - tb --host $TB_HOST --token $TB_ADMIN_TOKEN auth info

    # Try delete previous Environment
    - |
      output=$(tb --host $TB_HOST --token $TB_ADMIN_TOKEN env ls)
      AUTHOR=$(echo "$CI_COMMIT_AUTHOR" | sed -E 's/[^a-zA-Z0-9]//g')
      ENVIRONMENT_NAME="tmp_ci_${_NORMALIZED_ENV_NAME}_${AUTHOR}"

      # Check if the environment name exists in the output
      if echo "$output" | grep -q "\b$ENVIRONMENT_NAME\b"; then
          tb \
            --host $TB_HOST \
            --token $TB_ADMIN_TOKEN \
            env rm $ENVIRONMENT_NAME \
            --yes
      else
          echo "Skipping clean up: The Environment '$ENVIRONMENT_NAME' does not exist."
      fi

    # Create new test Environment with data
    - |
      tb \
        --host $TB_HOST \
        --token $TB_ADMIN_TOKEN \
        env create ${ENVIRONMENT_NAME} \
        ${_ENV_FLAGS}

    # Deploy changes to the test Environment
    - |
      DEPLOY_FILE=./deploy/${VERSION}/deploy.sh
      if [ ! -f "$DEPLOY_FILE" ]; then
        if [ "$TB_DEPLOY" = "true" ]; then
          tb --semver ${VERSION} deploy --v3 ${CI_FLAGS}
          tb release ls
        else
          tb deploy --populate --fixtures --wait
        fi
      fi

    # Custom deployment to the test Environment
    - |
      DEPLOY_FILE=./deploy/${VERSION}/deploy.sh
      if [ -f "$DEPLOY_FILE" ]; then
        if ! [ -x "$DEPLOY_FILE" ]; then
          echo "Error: You do not have permission to execute '$DEPLOY_FILE'. Run:"
          echo "> chmod +x $DEPLOY_FILE"
          echo "and commit your changes"
          exit 1
        else
          $DEPLOY_FILE
        fi
      fi

.tb_test:
  stage: ci
  image: ${IMAGE_BASE}
  interruptible: true
  before_script:
    - apt-get update && apt-get install -y --no-install-recommends git
  script:
    - *validate_input
    - _ENV_FLAGS="${ENV_FLAGS:=--last-partition --wait}"
    - cd $CI_PROJECT_DIR/$DATA_PROJECT_DIR
    - _NORMALIZED_ENV_NAME=$(echo $DATA_PROJECT_DIR | rev | cut -d "/" -f 1 | rev | tr '.-' '_')
    - source .tinyenv

    # Create Python Virtual Environment
    - python -m venv .venv
    - source .venv/bin/activate

    # Install Tinybird CLI
    - |
      if [ -f "requirements.txt" ]; then
        pip install -r requirements.txt
      else
        pip install tinybird-cli
      fi

    # Tinybird version
    - tb --version

    # Check auth
    - tb --host $TB_HOST --token $TB_ADMIN_TOKEN auth info

    # Use CI environment
    - |
      AUTHOR=$(echo "$CI_COMMIT_AUTHOR" | sed -E 's/[^a-zA-Z0-9]//g')
      ENVIRONMENT_NAME="tmp_ci_${_NORMALIZED_ENV_NAME}_${AUTHOR}"
      tb --host $TB_HOST --token $TB_ADMIN_TOKEN env use $ENVIRONMENT_NAME

    # Custom test data operations
    - |
      DATAOPS_FILE=./deploy/${VERSION}/dataops.sh
      if [ -f "$DATAOPS_FILE" ]; then
        if ! [ -x "$DATAOPS_FILE" ]; then
          echo "Error: You do not have permission to execute '$DATAOPS_FILE'. Run:"
          echo "> chmod +x $DATAOPS_FILE"
          echo "and commit your changes"
          exit 1
        else
          $DATAOPS_FILE
        fi
      fi

    - |
      if [ -f ./scripts/exec_test.sh ]; then
        ./scripts/exec_test.sh
      fi

    # Run data quality tests
    - tb test run -v -c 4

    # Run pipe regression tests
    - echo ${CI_MERGE_REQUEST_LABELS}
    - REGRESSION_LABELS=$(echo "${CI_MERGE_REQUEST_LABELS}" | awk -F, '{for (i=1; i<=NF; i++) if ($i ~ /^--/) print $i}' ORS=',' | sed 's/,$//')
    - echo ${REGRESSION_LABELS}
    - |
      CONFIG_FILE=./tests/regression.yaml
      BASE_CMD="tb env regression-tests"
      LABELS_CMD="$(echo ${REGRESSION_LABELS} | tr , ' ')"
      if [ -f ${CONFIG_FILE} ]; then
          echo "Config file found: ${CONFIG_FILE}"
          ${BASE_CMD} -f ${CONFIG_FILE} --wait ${LABELS_CMD}
      else
          echo "Config file not found at '${CONFIG_FILE}', running with default values"
          ${BASE_CMD} coverage --wait ${LABELS_CMD}
      fi

.tb_deploy_main:
  stage: cd
  image: ${IMAGE_BASE}
  interruptible: true
  before_script:
    - apt-get update && apt-get install -y --no-install-recommends git
  script:
    - *validate_input
    - _ENV_FLAGS="${ENV_FLAGS:=--last-partition --wait}"
    - cd $CI_PROJECT_DIR/$DATA_PROJECT_DIR
    - _NORMALIZED_ENV_NAME=$(echo $DATA_PROJECT_DIR | rev | cut -d "/" -f 1 | rev | tr '.-' '_')
    - source .tinyenv

    # Create Python Virtual Environment
    - python -m venv .venv
    - source .venv/bin/activate

    # Install Tinybird CLI
    - |
      if [ -f "requirements.txt" ]; then
        pip install -r requirements.txt
      else
        pip install tinybird-cli
      fi

    # Tinybird version
    - tb --version

    # Check all the data files syntax
    - tb check

    # Check auth info
    - tb --host $TB_HOST --token $TB_ADMIN_TOKEN auth info

    # Deploy changes to the main Workspace
    - |
      DEPLOY_FILE=./deploy/${VERSION}/deploy.sh
      if [ ! -f "$DEPLOY_FILE" ]; then
        if [ "$TB_DEPLOY" = "true" ]; then
          tb --semver ${VERSION} deploy --v3 ${CD_FLAGS}
          tb release ls
        else
          tb deploy
        fi
      fi

    # OPTIONALLY Custom deployment to main Workspace. Useful for post CD deploy commands (e.g.: tb pipe populate)
    - |
      DEPLOY_FILE=./deploy/${VERSION}/deploy.sh
      if [ -f "$DEPLOY_FILE" ]; then
        if ! [ -x "$DEPLOY_FILE" ]; then
          echo "Error: You do not have permission to execute '$DEPLOY_FILE'. Run:"
          echo "> chmod +x $DEPLOY_FILE"
          echo "and commit your changes"
          exit 1
        else
          $DEPLOY_FILE
        fi
      fi

.tb_cleanup_ci_branch:
  stage: cleanup
  image: ${IMAGE_BASE}
  script:
    - *validate_input
    - cd $CI_PROJECT_DIR/$DATA_PROJECT_DIR
    - _NORMALIZED_ENV_NAME=$(echo $DATA_PROJECT_DIR | rev | cut -d "/" -f 1 | rev | tr '.-' '_')
    - AUTHOR=$(echo "$CI_COMMIT_AUTHOR" | sed -E 's/[^a-zA-Z0-9]//g')
    - ENVIRONMENT_NAME="tmp_ci_${_NORMALIZED_ENV_NAME}_${AUTHOR}"

    # Create Python Virtual Environment
    - python -m venv .venv
    - source .venv/bin/activate

    # Install Tinybird CLI
    - |
      if [ -f "requirements.txt" ]; then
        pip install -r requirements.txt
      else
        pip install tinybird-cli
      fi

    # Tinybird version
    - tb --version

    # Remove test Environment
    - |
      tb \
      --host $TB_HOST \
      --token $TB_ADMIN_TOKEN \
      env rm ${ENVIRONMENT_NAME} \
      --yes

.release_promote:
  stage: release
  image: ${IMAGE_BASE}
  script:
    - cd $CI_PROJECT_DIR/$DATA_PROJECT_DIR

    # Create Python Virtual Environment
    - python -m venv .venv
    - source .venv/bin/activate

    # Install Tinybird CLI
    - |
      if [ -f "requirements.txt" ]; then
        pip install -r requirements.txt
      else
        pip install tinybird-cli
      fi

    # Tinybird version
    - tb --version

    # Promote Release
    - |
      source .tinyenv
      tb \
      --host $TB_HOST \
      --token $TB_ADMIN_TOKEN \
      release promote \
      --semver $VERSION

.release_rollback:
  stage: release
  image: ${IMAGE_BASE}
  script:
    - cd $CI_PROJECT_DIR/$DATA_PROJECT_DIR

    # Create Python Virtual Environment
    - python -m venv .venv
    - source .venv/bin/activate

    # Install Tinybird CLI
    - |
      if [ -f "requirements.txt" ]; then
        pip install -r requirements.txt
      else
        pip install tinybird-cli
      fi

    # Tinybird version
    - tb --version

    # Promote Release
    - |
      source .tinyenv
      tb \
      --host $TB_HOST \
      --token $TB_ADMIN_TOKEN \
      release rollback --yes

.release_rm:
  stage: release
  image: ${IMAGE_BASE}
  script:
    - cd $CI_PROJECT_DIR/$DATA_PROJECT_DIR

    # Create Python Virtual Environment
    - python -m venv .venv
    - source .venv/bin/activate

    # Install Tinybird CLI
    - |
      if [ -f "requirements.txt" ]; then
        pip install -r requirements.txt
      else
        pip install tinybird-cli
      fi

    # Tinybird version
    - tb --version

    # Promote Release
    - |
      source .tinyenv
      tb \
      --host $TB_HOST \
      --token $TB_ADMIN_TOKEN \
      release rm --semver $VERSION --force --yes
